<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./css/flexboxgrid.css" />
    <link rel="stylesheet" href="./css/pico.css" />
    <title>Rich ðŸ¤‘ in 2 years segÃºn W</title>
  </head>
  <body>
    <div class="container">
      <header><h1>Crypto - Rich ðŸ¤‘ in 2 years segÃºn W</h1></header>

      <main>
        <form action="#" id="form">
          <button type="submit" id="get-crypto">Make me rich ðŸ¤‘</button>

          <div>
            <div class="row">
              <div class="col-xs-12 col-md-4">
                <label for="min-price">Min price</label>
                <input type="number" id="min-price" step="any" required />
              </div>
              <div class="col-xs-12 col-md-4">
                <label for="max-price">Max price</label>
                <input type="number" id="max-price" step="any" required />
              </div>
              <div class="col-xs-12 col-md-4">
                <label for="max-supply">Max supply</label>
                <input
                  type="number"
                  id="max-supply"
                  value="1000000000"
                  required
                />
              </div>
              <div class="col-xs-12">
                <hr />
              </div>
              <div class="col-xs-12">
                <h3>Network</h3>
                <div style="display: inline-block">
                  <input
                    type="checkbox"
                    id="binance-smart-chain"
                    value="binance-smart-chain"
                    checked
                  />
                  <label for="binance-smart-chain">Binance Smart Chain</label>
                </div>
              </div>
              <div class="col-xs-12">
                <hr />
              </div>
              <div class="col-xs-12">
                <h3>Extra filters</h3>
                <label for="date-addded">Date added</label>
                <input
                  type="date"
                  id="date-added"
                  value="2019-01-01"
                  required
                />
              </div>
            </div>
          </div>
        </form>
        <button
          id="clear-filters"
          style="
            width: 200px;
            background-color: var(--del-color);
            border-color: var(--del-color);
          "
        >
          ðŸ—™ Clear filters
        </button>

        <div>
          <h3>Total found: <span id="total-found"></span></h3>
          <table>
            <thead>
              <tr>
                <th>#Rank</th>
                <th>Name</th>
                <th>Price</th>
                <th style="text-align: center;">Supply</th>
                <th>Market Cap</th>
                <th>Change (24h)</th>
              </tr>
            </thead>
            <tbody id="crypto-table"></tbody>
          </table>
        </div>
      </main>
    </div>
  </body>
  <script>
    var formatter = new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
    });

    document.querySelector('#min-price').value =
      localStorage.getItem('min-price') || 0.000001;
    document.querySelector('#max-price').value =
      localStorage.getItem('max-price') || 0.01;
    document.querySelector('#max-supply').value =
      localStorage.getItem('max-supply') || 1000000000;
    document.querySelector('#date-added').value =
      localStorage.getItem('date-added') || '2021-01-01';

    // clear filters
    document.querySelector('#clear-filters').addEventListener('click', () => {
      setDefaultInputsValues();
    });

    // watch local storage for check if user has custom filters for show clear filter button
    // show cle3ar filters button if user has custom filters
    document.querySelector('#clear-filters').style.display =
      localStorage.getItem('has-custom-filters') ? 'block' : 'none';

    document.querySelector('#form').addEventListener('submit', () => {
      document.querySelector('#get-crypto').setAttribute('aria-busy', true);
      const minPrice = document.querySelector('#min-price').value;
      const maxPrice = document.querySelector('#max-price').value;
      const maxSupply = document.querySelector('#max-supply').value;
      const dateAdded = document.querySelector('#date-added').value;
      const network = document.querySelector('#binance-smart-chain').value;

      saveInputValuesOnLocalStorage();

      fetch(
        `./api/crypto?minPrice=${minPrice}&maxPrice=${maxPrice}&maxSupply=${maxSupply}&dateAdded=${dateAdded}&network=${network}`,
        {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        }
      )
        .then(async (response) => {
          if (response.ok) {
            return response.json();
          } else {
            throw await response.json();
          }
        })
        .then((data) => {
          const table = document.querySelector('#crypto-table');
          document.querySelector('#total-found').innerText = data.length;

          table.innerHTML = '';
          data.forEach((item) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${item.cmc_rank}</td>
              <td><a href="https://coinmarketcap.com/currencies/${
                item.slug
              }" target="_blank">${
              item.name
            } <div style="font-style:italic;color:grey">(${item.symbol})</div></a></td>
              <td nowrap>USD$ ${item.quote.USD.price.toFixed(7)}</td>
              <td style="text-align:center;">${item.circulating_supply.toFixed(0)}/${item.total_supply.toFixed(0)} 
                <div>
                  <ins>
                (${getSupplyPercent(
                  item.circulating_supply,
                  item.total_supply
                )})
                </ins>
              </div>
              </td>
              <td>${formatter.format(item.quote.USD.market_cap)}</td>
              <td>${formatter.format(item.quote.USD.volume_24h)}</td>
            `;
            table.appendChild(row);
            document.querySelector('#clear-filters').style.display = 'block';
          });
        })
        .catch((error) => {
          console.log(error);
        })
        .finally(() => {
          document
            .querySelector('#get-crypto')
            .setAttribute('aria-busy', false);
        });
    });

    function saveInputValuesOnLocalStorage() {
      localStorage.setItem(
        'min-price',
        document.querySelector('#min-price').value
      );
      localStorage.setItem(
        'max-price',
        document.querySelector('#max-price').value
      );
      localStorage.setItem(
        'max-supply',
        document.querySelector('#max-supply').value
      );
      localStorage.setItem(
        'date-added',
        document.querySelector('#date-added').value
      );
      localStorage.setItem(
        'binance-smart-chain',
        document.querySelector('#binance-smart-chain').value
      );
      localStorage.setItem('has-custom-filters', true);
    }

    function setDefaultInputsValues() {
      document.querySelector('#min-price').value = 0.000001;
      document.querySelector('#max-price').value = 0.01;
      document.querySelector('#max-supply').value = 1000000000;
      document.querySelector('#date-added').value = '2021-01-01';
      document.querySelector('#binance-smart-chain').checked = true;
      // Remove local storage values
      localStorage.removeItem('min-price');
      localStorage.removeItem('max-price');
      localStorage.removeItem('max-supply');
      localStorage.removeItem('date-added');
      localStorage.removeItem('binance-smart-chain');
      localStorage.removeItem('has-custom-filters');
      document.querySelector('#clear-filters').style.display = 'none';
    }

    function getSupplyPercent(supply, totalSupply) {
      const percent = ((Number(supply) / Number(totalSupply)) * 100).toFixed(2);
      return isNaN(percent) ? '' : percent + '%';
    }
  </script>
</html>
